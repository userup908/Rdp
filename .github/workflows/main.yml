name: SafeRDP
on:
  workflow_dispatch:
  # NO auto-schedule to avoid detection

jobs:
  secure-rdp:
    name: Secure Windows RDP
    runs-on: windows-2022  # Latest Windows Server
    timeout-minutes: 350   # Just under 6 hours limit
    
    steps:
      - name: System Preparation
        run: |
          # Disable Windows Defender for performance
          Set-MpPreference -DisableRealtimeMonitoring $true
          
          # Enable all performance features
          powercfg -change -standby-timeout-ac 0
          powercfg -change -disk-timeout-ac 0
          
      - name: Create Secure User
        run: |
          # Generate random strong password
          $password = -join ((33..126) | Get-Random -Count 12 | % {[char]$_})
          net user rdpuser "$password" /add
          net localgroup administrators rdpuser /add
          Write-Host "Password: $password" -ForegroundColor Green
          
      - name: Fast Setup Tools
        run: |
          # Skip heavy downloads - use lightweight alternatives
          Write-Host "Setting up fast connection tools..." -ForegroundColor Green
          
          # Download only essentials - lightweight versions
          Invoke-WebRequest -Uri "https://download.avica.com/AvicaLite_v8.0.8.9.exe" -OutFile "Avica.exe" -UseBasicParsing
          Invoke-WebRequest -Uri "https://github.com/chieunhatnang/VM-QuickConfig/releases/download/1.6.1/VMQuickConfig.exe" -OutFile "VMConfig.exe" -UseBasicParsing
          
      - name: Quick Installation
        run: |
          # Start Avica installation but DON'T wait for completion
          Start-Process "Avica.exe" -ArgumentList "/S"
          
          # Just copy essential tools to desktop
          Copy-Item "VMConfig.exe" "C:\Users\Public\Desktop\" -Force
          
          # Create desktop shortcuts for built-in browsers
          $WshShell = New-Object -comObject WScript.Shell
          $EdgeShortcut = $WshShell.CreateShortcut("C:\Users\Public\Desktop\Edge.lnk")
          $EdgeShortcut.TargetPath = "msedge.exe"
          $EdgeShortcut.Save()
          
          # Cleanup immediately - don't wait
          Remove-Item "Avica.exe", "VMConfig.exe" -Force -ErrorAction SilentlyContinue
          
          Write-Host "Fast setup completed!" -ForegroundColor Green
          
      - name: Display Connection Instructions
        run: |
          $ip = (Invoke-RestMethod -Uri 'https://httpbin.org/ip' -TimeoutSec 5).origin
          
          Write-Host "
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘         RDP CONNECTION READY!          â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸŒ IP Address: $ip
          ğŸ”Œ Port: 3389
          ğŸ‘¤ Username: rdpuser  
          ğŸ”‘ Password: (shown above)
          
          ğŸ“± CONNECTION METHODS:
          
          1ï¸âƒ£ Windows RDP (Recommended):
             â€¢ Win + R â†’ type 'mstsc' â†’ Enter
             â€¢ Computer: $ip
             â€¢ Username: rdpuser
             â€¢ Password: (from above)
          
          2ï¸âƒ£ Command Line:
             â€¢ mstsc /v:$ip
          
          3ï¸âƒ£ Avica (Installing...):
             â€¢ Download Avica from avica.com
             â€¢ Wait for Avica ID to appear
             â€¢ Enter ID in Avica app
          
          âœ… Server is READY - Connect now!
          " -ForegroundColor Green
          
      - name: Performance Optimization
        run: |
          # Optimize for maximum performance
          reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU" /v NoAutoUpdate /t REG_DWORD /d 1 /f
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f
          
          # Disable unnecessary services
          $services = @('Spooler', 'Fax', 'WSearch', 'SysMain')
          foreach ($service in $services) {
            Stop-Service $service -Force -ErrorAction SilentlyContinue
            Set-Service $service -StartupType Disabled -ErrorAction SilentlyContinue
          }
          
      - name: Ultra-Fast Keep-Alive
        run: |
          Write-Host "RDP Server is READY! Connect now!" -ForegroundColor Green
          
          # Minimal resource keep-alive
          $startTime = Get-Date
          $maxDuration = 345 * 60 # 345 minutes
          
          while ((Get-Date).Subtract($startTime).TotalSeconds -lt $maxDuration) {
            # Ultra light activity - just stay alive
            Start-Sleep 180  # 3 minute intervals
            Write-Host "." -NoNewline -ForegroundColor Gray
            
            # Clean exit before timeout
            if ((Get-Date).Subtract($startTime).TotalMinutes -gt 340) {
              Write-Host "`nSession ending gracefully..." -ForegroundColor Yellow
              break
            }
          }
